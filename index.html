<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assistente Digitale - Comune di Sabaudia</title>

<style>
body {
  margin:0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

/* BUBBLE */
#chat-toggle {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: #1F4E79;
  color: white;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  cursor:pointer;
  box-shadow:0 8px 24px rgba(0,0,0,0.25);
  z-index:9999;
  transition:0.3s;
}
#chat-toggle:hover {
  transform:scale(1.05);
}

/* CHAT BOX */
#chat {
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 380px;
  height: 560px;
  background:white;
  border-radius:16px;
  box-shadow:0 20px 50px rgba(0,0,0,0.25);
  display:none;
  flex-direction:column;
  overflow:hidden;
  z-index:9999;
}

/* HEADER */
#chat-header {
  background:#1F4E79;
  color:white;
  padding:12px 16px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}

#chat-header-left {
  display:flex;
  align-items:center;
  gap:10px;
}

#chat-header img {
  height:30px;
}

#chat-header-title {
  font-size:13px;
  line-height:1.2;
}
#chat-header-title strong {
  display:block;
  font-size:14px;
}

/* MESSAGES */
#chat-messages {
  flex:1;
  padding:16px;
  overflow-y:auto;
  background:#F5F7FA;
  display:flex;
  flex-direction:column;
}

.message {
  max-width:85%;
  padding:10px 14px;
  border-radius:14px;
  margin-bottom:10px;
  font-size:14px;
  line-height:1.4;
}

.bot {
  background:white;
  border:1px solid #E2E8F0;
}

.user {
  background:#1F4E79;
  color:white;
  align-self:flex-end;
}

/* INPUT */
#chat-input-area {
  display:flex;
  padding:12px;
  background:white;
  border-top:1px solid #E2E8F0;
}

#chat-input {
  flex:1;
  padding:10px;
  border-radius:10px;
  border:1px solid #CBD5E1;
  font-size:14px;
  outline:none;
}

#chat-send {
  margin-left:8px;
  padding:10px 16px;
  border:none;
  border-radius:10px;
  background:#1F4E79;
  color:white;
  cursor:pointer;
}

/* TYPING DOTS */
.typing {
  display:flex;
  gap:6px;
  align-items:center;
  padding:4px 0;
  background:transparent !important;
  border:none !important;
}

.typing span {
  width:6px;
  height:6px;
  background:#94A3B8;
  border-radius:50%;
  animation: blink 1.4s infinite both;
}
.typing span:nth-child(2) { animation-delay: .2s; }
.typing span:nth-child(3) { animation-delay: .4s; }

@keyframes blink {
  0% { opacity:.2; }
  20% { opacity:1; }
  100% { opacity:.2; }
}
</style>
</head>
<body>

<div id="chat-toggle">ðŸ’¬</div>

<div id="chat">
  <div id="chat-header">
    <div id="chat-header-left">
      <img src="logo-sabaudia.jpeg" alt="Logo">
      <div id="chat-header-title">
        <strong>Assistente Digitale</strong>
        Comune di Sabaudia
      </div>
    </div>
    <div style="cursor:pointer;" onclick="toggleChat()">âœ•</div>
  </div>

  <div id="chat-messages">
    <div class="message bot">
      Buongiorno ðŸ‘‹<br><br>
      Sono lâ€™Assistente Digitale del Comune di Sabaudia.<br>
      Come posso aiutarla?
    </div>
  </div>

  <div id="chat-input-area">
    <input type="text" id="chat-input" placeholder="Scriva la sua richiesta...">
    <button id="chat-send">Invia</button>
  </div>
</div>

<script>
const webhookURL = "https://pizzai25.app.n8n.cloud/webhook/assistente-comune-demo";

const chat = document.getElementById("chat");
const toggleBtn = document.getElementById("chat-toggle");
const input = document.getElementById("chat-input");
const messages = document.getElementById("chat-messages");

const session_id = localStorage.getItem("session_id") || crypto.randomUUID();
localStorage.setItem("session_id", session_id);

toggleBtn.addEventListener("click", toggleChat);
document.getElementById("chat-send").addEventListener("click", sendMessage);
input.addEventListener("keypress", e => { if(e.key==="Enter") sendMessage(); });

function toggleChat() {
  chat.style.display = chat.style.display === "flex" ? "none" : "flex";
}

function appendMessage(text, type) {
  const div = document.createElement("div");
  div.className = "message " + type;

  const urlRegex = /(https?:\/\/[^\s]+)/g;
  const formatted = text.replace(urlRegex, url =>
    `<a href="${url}" target="_blank" style="color:#1F4E79;font-weight:600;">${url}</a>`
  );

  div.innerHTML = formatted;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

function showTyping() {
  const div = document.createElement("div");
  div.className = "message bot typing";
  div.id = "typing";
  div.innerHTML = "<span></span><span></span><span></span>";
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

function removeTyping() {
  const typing = document.getElementById("typing");
  if (typing) typing.remove();
}

async function sendMessage() {
  const text = input.value.trim();
  if (!text) return;

  appendMessage(text, "user");
  input.value = "";
  showTyping();

  try {
    const response = await fetch(webhookURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        session_id: session_id,
        message: text
      })
    });

    const data = await response.json();

    removeTyping();
    appendMessage(data.reply || "Errore nel servizio.", "bot");

  } catch (err) {
    removeTyping();
    appendMessage("Errore di connessione.", "bot");
  }
}
</script>

</body>
</html>
